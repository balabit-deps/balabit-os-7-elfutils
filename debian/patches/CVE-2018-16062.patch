From 29e31978ba51c1051743a503ee325b5ebc03d7e9 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Sat, 18 Aug 2018 13:27:48 +0200
Subject: [PATCH] libdw, readelf: Make sure there is enough data to read full
 aranges header.

dwarf_getaranges didn't check if there was enough data left to read both
the address and segment size. readelf didn't check there was enough data
left to read the segment size.

https://sourceware.org/bugzilla/show_bug.cgi?id=23541

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 libdw/ChangeLog          | 5 +++++
 libdw/dwarf_getaranges.c | 4 ++++
 src/ChangeLog            | 5 +++++
 src/readelf.c            | 2 ++
 4 files changed, 16 insertions(+)

#diff --git a/libdw/ChangeLog b/libdw/ChangeLog
#index cb4f34e..472d922 100644
#--- a/libdw/ChangeLog
#+++ b/libdw/ChangeLog
#@@ -1,3 +1,8 @@
#+2018-08-18  Mark Wielaard  <mark@klomp.org>
#+
#+	* dwarf_getaranges.c (dwarf_getaranges.c): Make sure there is enough
#+	data to read the address and segment size.
#+
# 2018-07-04  Ross Burton <ross.burton@intel.com>
# 
# 	* libdw_alloc.c: Remove error.h include.
Index: elfutils-0.170/libdw/dwarf_getaranges.c
===================================================================
--- elfutils-0.170.orig/libdw/dwarf_getaranges.c	2019-06-07 10:35:33.951059406 -0400
+++ elfutils-0.170/libdw/dwarf_getaranges.c	2019-06-07 10:35:33.947059391 -0400
@@ -148,6 +148,10 @@ dwarf_getaranges (Dwarf *dbg, Dwarf_Aran
 				   length_bytes, &offset, IDX_debug_info, 4))
 	goto fail;
 
+      /* Next up two bytes for address and segment size.  */
+      if (readp + 2 > readendp)
+	goto invalid;
+
       unsigned int address_size = *readp++;
       if (unlikely (address_size != 4 && address_size != 8))
 	goto invalid;
Index: elfutils-0.170/src/readelf.c
===================================================================
--- elfutils-0.170.orig/src/readelf.c	2019-06-07 10:35:33.951059406 -0400
+++ elfutils-0.170/src/readelf.c	2019-06-07 10:35:33.947059391 -0400
@@ -4928,6 +4928,8 @@ print_debug_aranges_section (Dwfl_Module
 	  goto next_table;
 	}
 
+      if (readp + 1 > readendp)
+	goto invalid_data;
       unsigned int segment_size = *readp++;
       printf (gettext (" Segment size:  %6" PRIu64 "\n\n"),
 	      (uint64_t) segment_size);
