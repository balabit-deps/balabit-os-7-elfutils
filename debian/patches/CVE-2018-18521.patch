From 2b16a9be69939822dcafe075413468daac98b327 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Thu, 18 Oct 2018 19:01:52 +0200
Subject: [PATCH] arlib: Check that sh_entsize isn't zero.

A bogus ELF file could have sh_entsize as zero. Don't divide by zero,
but just assume there are no symbols in the section.

https://sourceware.org/bugzilla/show_bug.cgi?id=23786

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 src/ChangeLog | 4 ++++
 src/arlib.c   | 3 +++
 2 files changed, 7 insertions(+)

#diff --git a/src/ChangeLog b/src/ChangeLog
#index 40de5a0..92beb1b 100644
#--- a/src/ChangeLog
#+++ b/src/ChangeLog
#@@ -1,3 +1,7 @@
#+2018-10-18  Mark Wielaard  <mark@klomp.org>
#+
#+	* arlib.c (arlib_add_symbols): Check that sh_entsize is not zero.
#+
# 2018-10-14  Mark Wielaard  <mark@klomp.org>
# 
# 	* ar.c (do_oper_extract): Assume epoch if ar_date is bogus.
diff --git a/src/arlib.c b/src/arlib.c
index 778e087..a6521e3 100644
--- a/src/arlib.c
+++ b/src/arlib.c
@@ -252,6 +252,9 @@ arlib_add_symbols (Elf *elf, const char *arfname, const char *membername,
       if (data == NULL)
 	continue;
 
+      if (shdr->sh_entsize == 0)
+	continue;
+
       int nsyms = shdr->sh_size / shdr->sh_entsize;
       for (int ndx = shdr->sh_info; ndx < nsyms; ++ndx)
 	{
-- 
2.9.3

