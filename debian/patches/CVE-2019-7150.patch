From da5c5336a1eaf519de246f7d9f0f5585e1d4ac59 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Sun, 20 Jan 2019 23:05:56 +0100
Subject: [PATCH] libdwfl: Sanity check partial core file dyn data read.

When reading the dyn data from the core file check if we got everything,
or just part of the data.

https://sourceware.org/bugzilla/show_bug.cgi?id=24103

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 libdwfl/ChangeLog                    | 5 +++++
 libdwfl/dwfl_segment_report_module.c | 6 ++++++
 2 files changed, 11 insertions(+)

#diff --git a/libdwfl/ChangeLog b/libdwfl/ChangeLog
#index c295fa7..de45e7f 100644
#--- a/libdwfl/ChangeLog
#+++ b/libdwfl/ChangeLog
#@@ -1,3 +1,8 @@
#+2019-01-20  Mark Wielaard  <mark@klomp.org>
#+
#+	* dwfl_segment_report_module.c (dwfl_segment_report_module): Check
#+	dyn_filesz vs dyn_data_size after read_portion call.
#+
# 2019-01-16  Mark Wielaard  <mark@klomp.org>
# 
# 	* linux-core-attach.c (core_next_thread): Pass desc to ebl_core_note.
Index: elfutils-0.170/libdwfl/dwfl_segment_report_module.c
===================================================================
--- elfutils-0.170.orig/libdwfl/dwfl_segment_report_module.c	2019-06-07 10:56:19.911910022 -0400
+++ elfutils-0.170/libdwfl/dwfl_segment_report_module.c	2019-06-07 10:56:19.907910006 -0400
@@ -765,6 +765,12 @@ dwfl_segment_report_module (Dwfl *dwfl,
   if (dyn_filesz != 0 && dyn_filesz % dyn_entsize == 0
       && ! read_portion (&dyn_data, &dyn_data_size, dyn_vaddr, dyn_filesz))
     {
+      /* dyn_data_size will be zero if we got everything from the initial
+         buffer, otherwise it will be the size of the new buffer that
+         could be read.  */
+      if (dyn_data_size != 0)
+	dyn_filesz = dyn_data_size;
+
       void *dyns = malloc (dyn_filesz);
       Elf32_Dyn (*d32)[dyn_filesz / sizeof (Elf32_Dyn)] = dyns;
       Elf64_Dyn (*d64)[dyn_filesz / sizeof (Elf64_Dyn)] = dyns;
