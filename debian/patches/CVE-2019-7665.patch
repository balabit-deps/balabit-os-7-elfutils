From de01cc6f9446187d69b9748bb3636361c79e77a4 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Wed, 16 Jan 2019 15:41:31 +0100
Subject: [PATCH] libebl: Check NT_PLATFORM core notes contain a zero
 terminated string.

Most strings in core notes are fixed size. But NT_PLATFORM contains just
a variable length string. Check that it is actually zero terminated
before passing to readelf to print.

https://sourceware.org/bugzilla/show_bug.cgi?id=24089

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 libdwfl/ChangeLog           |  5 +++++
 libdwfl/linux-core-attach.c |  9 +++++----
 libebl/ChangeLog            |  6 ++++++
 libebl/eblcorenote.c        | 39 +++++++++++++++++++--------------------
 libebl/libebl.h             |  3 ++-
 src/ChangeLog               |  4 ++++
 src/readelf.c               |  2 +-
 7 files changed, 42 insertions(+), 26 deletions(-)

#diff --git a/libdwfl/ChangeLog b/libdwfl/ChangeLog
#index b96cebf..c295fa7 100644
#--- a/libdwfl/ChangeLog
#+++ b/libdwfl/ChangeLog
#@@ -1,3 +1,8 @@
#+2019-01-16  Mark Wielaard  <mark@klomp.org>
#+
#+	* linux-core-attach.c (core_next_thread): Pass desc to ebl_core_note.
#+	(core_set_initial_registers): Likewise.
#+
# 2018-10-23  Mark Wielaard  <mark@klomp.org>
# 
# 	* relocate.c (relocate_section): Only sanity check mmapped Elf files
Index: elfutils-0.170/libdwfl/linux-core-attach.c
===================================================================
--- elfutils-0.170.orig/libdwfl/linux-core-attach.c	2019-06-07 11:03:38.853592614 -0400
+++ elfutils-0.170/libdwfl/linux-core-attach.c	2019-06-07 11:03:38.853592614 -0400
@@ -137,7 +137,7 @@ core_next_thread (Dwfl *dwfl __attribute
       const Ebl_Register_Location *reglocs;
       size_t nitems;
       const Ebl_Core_Item *items;
-      if (! ebl_core_note (core_arg->ebl, &nhdr, name,
+      if (! ebl_core_note (core_arg->ebl, &nhdr, name, desc,
 			   &regs_offset, &nregloc, &reglocs, &nitems, &items))
 	{
 	  /* This note may be just not recognized, skip it.  */
@@ -191,8 +191,9 @@ core_set_initial_registers (Dwfl_Thread
   const Ebl_Register_Location *reglocs;
   size_t nitems;
   const Ebl_Core_Item *items;
-  int core_note_err = ebl_core_note (core_arg->ebl, &nhdr, name, &regs_offset,
-				     &nregloc, &reglocs, &nitems, &items);
+  int core_note_err = ebl_core_note (core_arg->ebl, &nhdr, name, desc,
+				     &regs_offset, &nregloc, &reglocs,
+				     &nitems, &items);
   /* __libdwfl_attach_state_for_core already verified the note is there.  */
   assert (core_note_err != 0);
   assert (nhdr.n_type == NT_PRSTATUS);
@@ -381,7 +382,7 @@ dwfl_core_file_attach (Dwfl *dwfl, Elf *
       const Ebl_Register_Location *reglocs;
       size_t nitems;
       const Ebl_Core_Item *items;
-      if (! ebl_core_note (ebl, &nhdr, name,
+      if (! ebl_core_note (ebl, &nhdr, name, desc,
 			   &regs_offset, &nregloc, &reglocs, &nitems, &items))
 	{
 	  /* This note may be just not recognized, skip it.  */
Index: elfutils-0.170/libebl/eblcorenote.c
===================================================================
--- elfutils-0.170.orig/libebl/eblcorenote.c	2019-06-07 11:03:38.853592614 -0400
+++ elfutils-0.170/libebl/eblcorenote.c	2019-06-07 11:03:38.853592614 -0400
@@ -36,11 +36,13 @@
 #include <inttypes.h>
 #include <stdio.h>
 #include <stddef.h>
+#include <string.h>
 #include <libeblP.h>
 
 
 int
 ebl_core_note (Ebl *ebl, const GElf_Nhdr *nhdr, const char *name,
+	       const char *desc,
 	       GElf_Word *regs_offset, size_t *nregloc,
 	       const Ebl_Register_Location **reglocs, size_t *nitems,
 	       const Ebl_Core_Item **items)
@@ -51,28 +53,25 @@ ebl_core_note (Ebl *ebl, const GElf_Nhdr
     {
       /* The machine specific function did not know this type.  */
 
-      *regs_offset = 0;
-      *nregloc = 0;
-      *reglocs = NULL;
-      switch (nhdr->n_type)
+      /* NT_PLATFORM is kind of special since it needs a zero terminated
+         string (other notes often have a fixed size string).  */
+      static const Ebl_Core_Item platform[] =
 	{
-#define ITEMS(type, table)				\
-	  case type:					\
-	    *items = table;				\
-	    *nitems = sizeof table / sizeof table[0];	\
-	    result = 1;					\
-	    break
-
-	  static const Ebl_Core_Item platform[] =
-	    {
-	      {
-		.name = "Platform",
-		.type = ELF_T_BYTE, .count = 0, .format = 's'
-	      }
-	    };
-	  ITEMS (NT_PLATFORM, platform);
-
-#undef	ITEMS
+	  {
+	    .name = "Platform",
+	    .type = ELF_T_BYTE, .count = 0, .format = 's'
+	  }
+	};
+
+      if (nhdr->n_type == NT_PLATFORM
+	  && memchr (desc, '\0', nhdr->n_descsz) != NULL)
+        {
+	  *regs_offset = 0;
+	  *nregloc = 0;
+	  *reglocs = NULL;
+	  *items = platform;
+	  *nitems = 1;
+	  result = 1;
 	}
     }
 
Index: elfutils-0.170/libebl/libebl.h
===================================================================
--- elfutils-0.170.orig/libebl/libebl.h	2019-06-07 11:03:38.853592614 -0400
+++ elfutils-0.170/libebl/libebl.h	2019-06-07 11:03:38.853592614 -0400
@@ -317,7 +317,8 @@ typedef struct
 
 /* Describe the format of a core file note with the given header and NAME.
    NAME is not guaranteed terminated, it's NHDR->n_namesz raw bytes.  */
-extern int ebl_core_note (Ebl *ebl, const GElf_Nhdr *nhdr, const char *name,
+extern int ebl_core_note (Ebl *ebl, const GElf_Nhdr *nhdr,
+			  const char *name, const char *desc,
 			  GElf_Word *regs_offset, size_t *nregloc,
 			  const Ebl_Register_Location **reglocs,
 			  size_t *nitems, const Ebl_Core_Item **items)
Index: elfutils-0.170/src/readelf.c
===================================================================
--- elfutils-0.170.orig/src/readelf.c	2019-06-07 11:03:38.853592614 -0400
+++ elfutils-0.170/src/readelf.c	2019-06-07 11:03:38.853592614 -0400
@@ -9541,7 +9541,7 @@ handle_core_note (Ebl *ebl, const GElf_N
   size_t nitems;
   const Ebl_Core_Item *items;
 
-  if (! ebl_core_note (ebl, nhdr, name,
+  if (! ebl_core_note (ebl, nhdr, name, desc,
 		       &regs_offset, &nregloc, &reglocs, &nitems, &items))
     return;
 
