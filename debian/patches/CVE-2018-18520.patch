From 22d2d082d57a7470fadc0eae67179553f4919209 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Thu, 18 Oct 2018 23:15:48 +0200
Subject: [PATCH] size: Handle recursive ELF ar files.

eu-size didn't handle an ELF ar file that contained an ar file itself
correctly. handle_ar would recursively call itself but close the ELF
file before returning. Only close the ELF file at the top-level.

https://sourceware.org/bugzilla/show_bug.cgi?id=23787

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 src/ChangeLog | 4 ++++
 src/size.c    | 6 ++++--
 2 files changed, 8 insertions(+), 2 deletions(-)

#diff --git a/src/ChangeLog b/src/ChangeLog
#index 92beb1b..a6ab093 100644
#--- a/src/ChangeLog
#+++ b/src/ChangeLog
#@@ -1,5 +1,9 @@
# 2018-10-18  Mark Wielaard  <mark@klomp.org>
# 
#+	* size.c (handle_ar): Only close elf if prefix was NULL.
#+
#+2018-10-18  Mark Wielaard  <mark@klomp.org>
#+
# 	* arlib.c (arlib_add_symbols): Check that sh_entsize is not zero.
# 
# 2018-10-14  Mark Wielaard  <mark@klomp.org>
Index: elfutils-0.170/src/size.c
===================================================================
--- elfutils-0.170.orig/src/size.c	2019-06-07 10:40:53.152305031 -0400
+++ elfutils-0.170/src/size.c	2019-06-07 10:40:53.148305016 -0400
@@ -375,8 +375,10 @@ handle_ar (int fd, Elf *elf, const char
 	INTERNAL_ERROR (fname);
     }
 
-  if (unlikely (elf_end (elf) != 0))
-    INTERNAL_ERROR (fname);
+  /* Only close ELF handle if this was a "top level" ar file.  */
+  if (prefix == NULL)
+    if (unlikely (elf_end (elf) != 0))
+      INTERNAL_ERROR (fname);
 
   return result;
 }
